<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top 50 IOS Broker List Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --navy: #002d62;
      --navy-dark: #021c3d;
      --ink: #0a152b;
      --muted: #555;
      --accent: #0a66c2;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f9;
      color: var(--ink);
    }
    #header {
      background: linear-gradient(90deg, var(--navy-dark), var(--navy));
      color: #fff;
      padding: 14px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #title {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #marketSelect {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    #toggleCounties {
      background: #ffffff;
      color: var(--navy);
      border: none;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    #toggleCounties.is-on {
      background: #5fa8ff;
      color: #0a1f46;
    }
    #map {
      height: calc(100vh - 70px);
      width: 100%;
    }
    .rank-pin {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--navy);
      color: #fff;
      text-align: center;
      line-height: 32px;
      font-size: 13px;
      font-weight: 700;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .rank-pin.is-top {
      background: #5fa8ff;
      color: #0a1f46;
      border-color: #ffffff;
      box-shadow: 0 4px 10px rgba(95, 168, 255, 0.45);
    }
    .leaflet-popup-content-wrapper {
      border-radius: 10px;
      max-width: 340px;
    }
    .popup-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--navy);
      margin-bottom: 4px;
    }
    .rank-label {
      font-size: 13px;
      margin-bottom: 10px;
      color: var(--muted);
    }
    .broker {
      margin-bottom: 10px;
      font-size: 13px;
    }
    .broker-name {
      font-weight: 600;
    }
    .meta {
      font-size: 12px;
      color: var(--muted);
    }
    a {
      color: var(--accent);
      text-decoration: none;
    }
    .notice {
      position: absolute;
      left: 16px;
      bottom: 16px;
      background: #132b5d;
      border: 1px solid rgba(255,255,255,0.2);
      color: #cfe0ff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      max-width: 340px;
      z-index: 500;
      display: none;
    }
    .logo {
      width: 90px;
      height: auto;
      display: inline-block;
      border-radius: 10px;
      background: #ffffff;
      padding: 4px 6px;
    }
    @media (max-width: 800px) {
      #header { flex-direction: column; align-items: flex-start; }
      #marketSelect { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="title">
      <img class="logo" src="National IOS - MAIN (14).png" alt="National IOS logo" />
      Top 50 IOS Brokers by MSA
    </div>
    <div id="controls">
      <button id="toggleCounties" type="button">Show All Counties</button>
      <select id="marketSelect">
        <option value="">Select a Market</option>
      </select>
    </div>
  </div>

  <div id="map"></div>
  <div id="notice" class="notice"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    const SHEET_GVIZ_URL = "https://docs.google.com/spreadsheets/d/12Elp_eoZyGx7Vz7YHKIMVFT8PPz-69_5Ch27gJm5Eh4/gviz/tq?tqx=out:json&gid=0";
    const SHEET_GVIZ_PUBLISHED_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSYkwcIW0fyYXLdGC4VndZy_snIEJ55SdicAFIHYlugHLiQ7pXUkeeFVFWukdQr3aDWwfScJoIl_jZv/gviz/tq?tqx=out:json";
    const COUNTIES_GEOJSON_URL = "data/counties_selected.geojson";

    const map = L.map("map", {
      zoomControl: true,
      scrollWheelZoom: true
    }).setView([39.5, -98.35], 4.6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    let countyData = null;
    let countyLayer = null;
    let currentMSA = null;
    let allRecords = [];
    let showAllCounties = false;
    const toggleCountiesButton = document.getElementById("toggleCounties");
    const select = document.getElementById("marketSelect");
    const notice = document.getElementById("notice");

    const columnAliases = {
      msa: ["msa", "market", "market name"],
      rank: ["rank", "#", "ranking"],
      name: ["broker", "broker name", "name", "contact"],
      phone: ["phone", "phone number", "cell"],
      email: ["email", "email address"],
      linkedin: ["linkedin", "linked in", "linked-in"],
      lat: ["lat", "latitude", "latitude "],
      lng: ["lng", "lon", "longitude", "long", "longitude "]
    };

    function parseCsv(text) {
      const rows = [];
      let row = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];
        if (char === '"') {
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          row.push(current);
          current = "";
        } else if (char === '\n' && !inQuotes) {
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
        } else if (char !== '\r') {
          current += char;
        }
      }
      if (current.length || row.length) {
        row.push(current);
        rows.push(row);
      }
      return rows;
    }

    function normalizeHeader(header) {
      return header.trim().toLowerCase();
    }

    function mapHeaders(headers) {
      const map = {};
      headers.forEach((header, idx) => {
        const normalized = normalizeHeader(header);
        for (const key in columnAliases) {
          if (columnAliases[key].includes(normalized)) {
            map[key] = idx;
          }
        }
      });
      return map;
    }

    function setNotice(message) {
      if (!message) {
        notice.style.display = "none";
        notice.textContent = "";
        return;
      }
      notice.textContent = message;
      notice.style.display = "block";
    }

    function brokerHTML(record) {
      return `
        <div class="broker">
          <div class="broker-name">${record.name || ""}</div>
          ${record.phone ? `<div class="meta">üìû ${record.phone}</div>` : ""}
          ${record.email ? `<div class="meta">‚úâÔ∏è ${record.email}</div>` : ""}
          ${record.linkedin ? `<div><a href="${record.linkedin}" target="_blank" rel="noopener">LinkedIn</a></div>` : ""}
        </div>
      `;
    }

    function buildPopup(market) {
      return `
        <div class="popup-title">${market.msa}</div>
        <div class="rank-label">Rank #${market.rank}</div>
        ${market.brokers.map(brokerHTML).join("")}
      `;
    }

    function clearMarkers() {
      markers.clearLayers();
    }

    function addMarkers(records) {
      clearMarkers();
      records.forEach((record) => {
        if (!record.lat || !record.lng) return;
        const isTop = String(record.rank).trim() === "1";
        const icon = L.divIcon({
          html: `<div class="rank-pin ${isTop ? "is-top" : ""}">${record.rank}</div>`,
          className: "",
          iconSize: [28, 28],
          iconAnchor: [14, 28],
          popupAnchor: [0, -28]
        });
        const marker = L.marker([record.lat, record.lng], { icon });
        marker.bindPopup(buildPopup(record));
        marker.on("popupopen", () => {
          currentMSA = record.msa;
          renderCounties(currentMSA, true);
        });
        marker.on("popupclose", () => {
          currentMSA = select.value || null;
          renderCounties(currentMSA, true);
        });
        markers.addLayer(marker);
      });
    }

    function populateMarkets(records) {
      records.forEach((record) => {
        if (!record.msa) return;
        const option = document.createElement("option");
        option.value = record.msa;
        const rankLabel = record.rank ? `#${record.rank} - ` : "";
        option.textContent = `${rankLabel}${record.msa}`;
        select.appendChild(option);
      });
    }

    function attachFilter(records) {
      select.addEventListener("change", () => {
        const value = select.value;
        currentMSA = value || null;
        renderCounties(currentMSA, true);
        if (!value) {
          map.setView([39.5, -98.35], 4);
        }
      });
    }

    function renderCounties(msa, fit = false) {
      if (countyLayer) {
        map.removeLayer(countyLayer);
        countyLayer = null;
      }
      if (!countyData) return;
      const normalizeMSA = (value) => {
        if (!value) return "";
        return value
          .toLowerCase()
          .split(",")[0]
          .replace(/\s+/g, " ")
          .trim();
      };
      const target = normalizeMSA(msa);
      countyLayer = L.geoJSON(countyData, {
        filter: (feature) => {
          if (showAllCounties) return true;
          return target && normalizeMSA(feature.properties.MSA_Name) === target;
        },
        style: {
          color: "#123c7a",
          weight: 2,
          fillOpacity: 0
        }
      }).addTo(map);
      if (fit && countyLayer.getLayers().length) {
        map.fitBounds(countyLayer.getBounds(), { padding: [30, 30] });
      }
    }

    async function loadCounties() {
      try {
        const resp = await fetch(COUNTIES_GEOJSON_URL, { cache: "no-store" });
        if (!resp.ok) return;
        countyData = await resp.json();
        renderCounties(currentMSA, true);
      } catch (err) {
        // County outlines are optional; ignore on failure
      }
    }

    function loadDataFromTable(table) {
      const headers = table.cols.map(col => col.label || "");
      const headerMap = mapHeaders(headers || []);

      if (headerMap.lat === undefined || headerMap.lng === undefined || headerMap.msa === undefined) {
        setNotice("Sheet must include columns for MSA, Latitude, and Longitude. Add 'Latitude' and 'Longitude' columns to place dots on the map.");
      } else {
        setNotice("");
      }

      const raw = table.rows.map((row) => {
        const cells = row.c || [];
        const get = (idx) => (idx === undefined || !cells[idx]) ? "" : String(cells[idx].v ?? "");
        return {
          msa: get(headerMap.msa),
          rank: get(headerMap.rank),
          name: get(headerMap.name),
          phone: get(headerMap.phone),
          email: get(headerMap.email),
          linkedin: get(headerMap.linkedin),
          lat: parseFloat(get(headerMap.lat)),
          lng: parseFloat(get(headerMap.lng))
        };
      });

      const grouped = new Map();
      raw.forEach((row) => {
        if (!row.msa) return;
        if (!grouped.has(row.msa)) {
          grouped.set(row.msa, {
            msa: row.msa,
            rank: row.rank || "",
            lat: row.lat,
            lng: row.lng,
            brokers: []
          });
        }
        const market = grouped.get(row.msa);
        if (row.rank) market.rank = row.rank;
        if (!Number.isNaN(row.lat)) market.lat = row.lat;
        if (!Number.isNaN(row.lng)) market.lng = row.lng;
        if (row.name || row.phone || row.email || row.linkedin) {
          market.brokers.push({
            name: row.name,
            phone: row.phone,
            email: row.email,
            linkedin: row.linkedin
          });
        }
      });

      const records = Array.from(grouped.values()).filter(r => !Number.isNaN(r.lat) && !Number.isNaN(r.lng));
      records.sort((a, b) => Number(a.rank) - Number(b.rank));
      allRecords = records;

      populateMarkets(records);
      addMarkers(records);
      attachFilter(records);
    }

    function loadData() {
      setNotice("Loading broker data...");
      window.google = window.google || {};
      window.google.visualization = window.google.visualization || {};
      window.google.visualization.Query = window.google.visualization.Query || {};
      window.google.visualization.Query.setResponse = (response) => {
        try {
          if (!response || !response.table) {
            throw new Error("No table data");
          }
          loadDataFromTable(response.table);
        } catch (err) {
          setNotice("Could not parse the Google Sheet data. Check the column headers.");
        }
      };

      const script = document.createElement("script");
      script.src = SHEET_GVIZ_URL;
      script.onerror = () => {
        const fallback = document.createElement("script");
        fallback.src = SHEET_GVIZ_PUBLISHED_URL;
        fallback.onerror = () => setNotice("Could not load the Google Sheet. Ensure it is shared publicly or published to the web.");
        document.body.appendChild(fallback);
      };
      document.body.appendChild(script);
    }

    loadData();
    loadCounties();

    toggleCountiesButton.addEventListener("click", () => {
      showAllCounties = !showAllCounties;
      toggleCountiesButton.classList.toggle("is-on", showAllCounties);
      toggleCountiesButton.textContent = showAllCounties ? "Hide All Counties" : "Show All Counties";
      renderCounties(currentMSA, !showAllCounties ? true : false);
    });
  </script>
</body>
</html>
